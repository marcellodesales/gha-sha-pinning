name: docker-multiarch

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write
  artifact-metadata: write
  pull-requests: write

env:
  REGISTRY: ghcr.io
  TARGET_SERVICE: cli
  PLATFORMS: linux/amd64,linux/arm64

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  pr-build:
    timeout-minutes: 5
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Compute vars
        id: vars
        shell: bash
        run: |
          echo "pr=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "image_base=ghcr.io/$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata (PR)
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ steps.vars.outputs.image_base }}/pr/${{ steps.vars.outputs.pr }}
          tags: |
            type=raw,value=${{ github.sha }}
            type=raw,value=${{ steps.vars.outputs.short_sha }}
          labels: |
            org.opencontainers.image.title=${{ github.event.repository.name }}
            org.opencontainers.image.description=PR build for #${{ steps.vars.outputs.pr }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          flavor: latest=false

      - name: Build (PR)
        uses: docker/bake-action@4a9a8d494466d37134e2bfca2d3a8de8fb2681ad # v5.13.0
        with:
          files: |
            ./docker-compose.yml
          targets: ${{ env.TARGET_SERVICE }}
          push: true
          set: |
            ${{ env.TARGET_SERVICE }}.platform=${{ env.PLATFORMS }}
            ${{ env.TARGET_SERVICE }}.tags=${{ steps.meta.outputs.tags }}
            ${{ env.TARGET_SERVICE }}.labels=${{ steps.meta.outputs.labels }}
            ${{ env.TARGET_SERVICE }}.cache-from=type=gha,scope=${{ env.TARGET_SERVICE }}
            ${{ env.TARGET_SERVICE }}.cache-to=type=gha,mode=max,scope=${{ env.TARGET_SERVICE }}

      - name: Resolve image digest (PR)
        id: pr_digest
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_BASE="${{ steps.vars.outputs.image_base }}/pr/${{ steps.vars.outputs.pr }}"
          TAG="$IMAGE_BASE:${{ steps.vars.outputs.short_sha }}"
          DIGEST=$(docker buildx imagetools inspect "$TAG" --format '{{json .Manifest}}' | jq -r '.digest')
          echo "image_base=$IMAGE_BASE" >> $GITHUB_OUTPUT
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Attest build provenance (PR)
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        with:
          subject-name: ${{ steps.pr_digest.outputs.image_base }}
          subject-digest: ${{ steps.pr_digest.outputs.digest }}
          push-to-registry: true
          show-summary: true

      - name: Summarize build metadata (PR)
        shell: bash
        run: |
          {
            echo "### Docker image metadata (PR #${{ steps.vars.outputs.pr }})";
            echo "";
            echo "- Image: ${{ steps.pr_digest.outputs.image_base }}";
            echo "- Digest: ${{ steps.pr_digest.outputs.digest }}";
            echo "";
            echo "Tags:";
            echo '```';
            echo "${{ steps.meta.outputs.tags }}";
            echo '```';
            echo "Labels:";
            echo '```';
            echo "${{ steps.meta.outputs.labels }}";
            echo '```';
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Comment PR with build metadata
        if: github.event_name == 'pull_request'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        env:
          IMAGE: ${{ steps.pr_digest.outputs.image_base }}
          DIGEST: ${{ steps.pr_digest.outputs.digest }}
          TAGS: ${{ steps.meta.outputs.tags }}
          LABELS: ${{ steps.meta.outputs.labels }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = Number(process.env.PR_NUMBER);
            const marker = '<!-- docker-meta -->';
            const body = `${marker}
            ## Docker image metadata
            - Image: ${process.env.IMAGE}
            - Digest: ${process.env.DIGEST}

            <details><summary>Tags</summary>

            \`\`\`
            ${process.env.TAGS}
            \`\`\`
            </details>

            <details><summary>Labels</summary>

            \`\`\`
            ${process.env.LABELS}
            \`\`\`
            </details>
            `;
            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const previous = comments.find(c => c.user?.type === 'Bot' && c.body?.includes(marker));
            if (previous) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: previous.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }

  pr-delete:
    timeout-minutes: 5
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - name: Delete GHCR package for this PR
        env:
          GH_TOKEN: ${{ secrets.GHCR_DELETE_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          OWNER_TYPE: ${{ github.event.repository.owner.type }}
          PKG_NAME: ${{ github.event.repository.name }}/pr/${{ github.event.pull_request.number }}
        shell: bash
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "Missing GHCR_DELETE_TOKEN (must have delete:packages)."; exit 1
          fi
          ENCODED=$(jq -rn --arg s "$PKG_NAME" '$s|@uri')
          if [ "$OWNER_TYPE" = "Organization" ]; then
            PATH="/orgs/${REPO_OWNER}/packages/container/${ENCODED}"
          else
            PATH="/users/${REPO_OWNER}/packages/container/${ENCODED}"
          fi
          echo "Deleting GHCR package: ${PKG_NAME}"
          gh api -X DELETE "$PATH" -H "Accept: application/vnd.github+json" || echo "Nothing to delete or insufficient permissions."

  publish-on-merge:
    timeout-minutes: 5
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout merged base branch
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Compute vars (merge)
        id: merge_vars
        shell: bash
        run: |
          echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "image_base=ghcr.io/$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata (merge)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.merge_vars.outputs.image_base }}
          tags: |
            type=raw,value=${{ steps.merge_vars.outputs.branch }}
            type=raw,value=${{ steps.merge_vars.outputs.branch }}-${{ steps.merge_vars.outputs.short_sha }}
          labels: |
            org.opencontainers.image.title=${{ github.event.repository.name }}
            org.opencontainers.image.description=Publish on merge to ${{ steps.merge_vars.outputs.branch }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          flavor: latest=false

      - name: Build and push (merged to ${{ steps.merge_vars.outputs.branch }})
        uses: docker/bake-action@v5
        with:
          files: |
            ./docker-compose.yml
          targets: ${{ env.TARGET_SERVICE }}
          push: true
          set: |
            ${{ env.TARGET_SERVICE }}.platform=${{ env.PLATFORMS }}
            ${{ env.TARGET_SERVICE }}.tags=${{ steps.meta.outputs.tags }}
            ${{ env.TARGET_SERVICE }}.labels=${{ steps.meta.outputs.labels }}
            ${{ env.TARGET_SERVICE }}.cache-from=type=gha,scope=${{ env.TARGET_SERVICE }}
            ${{ env.TARGET_SERVICE }}.cache-to=type=gha,mode=max,scope=${{ env.TARGET_SERVICE }}

      - name: Resolve image digest (merge)
        id: merge_digest
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_BASE="${{ steps.merge_vars.outputs.image_base }}"
          TAG="$IMAGE_BASE:${{ steps.merge_vars.outputs.branch }}"
          DIGEST=$(docker buildx imagetools inspect "$TAG" --format '{{json .Manifest}}' | jq -r '.digest')
          echo "image_base=$IMAGE_BASE" >> $GITHUB_OUTPUT
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Attest build provenance (merge)
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ steps.merge_digest.outputs.image_base }}
          subject-digest: ${{ steps.merge_digest.outputs.digest }}
          push-to-registry: true
          show-summary: true

      - name: Summarize build metadata (merge)
        shell: bash
        run: |
          {
            echo "### Docker image metadata (merge to ${{ steps.merge_vars.outputs.branch }})";
            echo "";
            echo "- Image: ${{ steps.merge_digest.outputs.image_base }}";
            echo "- Digest: ${{ steps.merge_digest.outputs.digest }}";
            echo "";
            echo "Tags:";
            echo '```';
            echo "${{ steps.meta.outputs.tags }}";
            echo '```';
            echo "Labels:";
            echo '```';
            echo "${{ steps.meta.outputs.labels }}";
            echo '```';
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Comment PR with build metadata (merge)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          IMAGE: ${{ steps.merge_digest.outputs.image_base }}
          DIGEST: ${{ steps.merge_digest.outputs.digest }}
          TAGS: ${{ steps.meta.outputs.tags }}
          LABELS: ${{ steps.meta.outputs.labels }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = Number(process.env.PR_NUMBER);
            const marker = '<!-- docker-meta -->';
            const body = `${marker}
            ## Docker image metadata (merge)
            - Image: ${process.env.IMAGE}
            - Digest: ${process.env.DIGEST}

            <details><summary>Tags</summary>

            \`\`\`
            ${process.env.TAGS}
            \`\`\`
            </details>

            <details><summary>Labels</summary>

            \`\`\`
            ${process.env.LABELS}
            \`\`\`
            </details>
            `;
            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const previous = comments.find(c => c.user?.type === 'Bot' && c.body?.includes(marker));
            if (previous) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: previous.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }

  release-build:
    if: github.event_name == 'push' && github.ref_type == 'tag'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute vars
        id: vars
        shell: bash
        run: |
          echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          echo "image_base=ghcr.io/$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata (tag)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.vars.outputs.image_base }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.vars.outputs.tag }}
            type=raw,value=${{ steps.vars.outputs.tag }}-${{ steps.vars.outputs.short_sha }}
          labels: |
            org.opencontainers.image.title=${{ github.event.repository.name }}
            org.opencontainers.image.description=Release build for tag ${{ steps.vars.outputs.tag }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          flavor: latest=false

      - name: Build and push (tag ${{ steps.vars.outputs.tag }})
        uses: docker/bake-action@v5
        with:
          files: |
            ./docker-compose.yml
          targets: ${{ env.TARGET_SERVICE }}
          push: true
          set: |
            ${{ env.TARGET_SERVICE }}.platform=${{ env.PLATFORMS }}
            ${{ env.TARGET_SERVICE }}.tags=${{ steps.meta.outputs.tags }}
            ${{ env.TARGET_SERVICE }}.labels=${{ steps.meta.outputs.labels }}
            ${{ env.TARGET_SERVICE }}.cache-from=type=gha,scope=${{ env.TARGET_SERVICE }}
            ${{ env.TARGET_SERVICE }}.cache-to=type=gha,mode=max,scope=${{ env.TARGET_SERVICE }}

      - name: Resolve image digest (tag)
        id: tag_digest
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_BASE="${{ steps.vars.outputs.image_base }}"
          TAG="$IMAGE_BASE:${{ steps.vars.outputs.tag }}"
          DIGEST=$(docker buildx imagetools inspect "$TAG" --format '{{json .Manifest}}' | jq -r '.digest')
          echo "image_base=$IMAGE_BASE" >> $GITHUB_OUTPUT
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Attest build provenance (tag)
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ steps.tag_digest.outputs.image_base }}
          subject-digest: ${{ steps.tag_digest.outputs.digest }}
          push-to-registry: true
          show-summary: true

      - name: Summarize build metadata (tag)
        shell: bash
        run: |
          {
            echo "### Docker image metadata (tag ${{ steps.vars.outputs.tag }})";
            echo "";
            echo "- Image: ${{ steps.tag_digest.outputs.image_base }}";
            echo "- Digest: ${{ steps.tag_digest.outputs.digest }}";
            echo "";
            echo "Tags:";
            echo '```';
            echo "${{ steps.meta.outputs.tags }}";
            echo '```';
            echo "Labels:";
            echo '```';
            echo "${{ steps.meta.outputs.labels }}";
            echo '```';
          } >> "$GITHUB_STEP_SUMMARY"
